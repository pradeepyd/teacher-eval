"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[704],{30500:(e,t,a)=>{a.d(t,{A:()=>n});var s=a(95155),r=a(12115),i=a(56671);function n(e){let{term:t,onSubmit:a,_onCancel:n,loading:l=!1}=e,[o,d]=(0,r.useState)([]),[c,u]=(0,r.useState)({}),[m,h]=(0,r.useState)(""),[f,g]=(0,r.useState)(!1),[x,p]=(0,r.useState)(!0),[b,y]=(0,r.useState)(!0),[w,v]=(0,r.useState)(""),[j,N]=(0,r.useState)("idle"),S=(0,r.useRef)(null),C=(0,r.useRef)({}),E=o.length,k=o.reduce((e,t)=>{var a;return e+ +(((null==(a=c[t.id])?void 0:a.trim())||"").length>0)},0),A=E?Math.round(k/E*100):0;(0,r.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/teacher-evaluation/questions?term=".concat(t));if(e.ok){let t=await e.json();d(t.questions),h(t.existingSelfComment),g(t.isSubmitted),p(t.canEdit);let a={};t.questions.forEach(e=>{a[e.id]=e.existingAnswer}),u(a)}else v("Failed to fetch questions")}catch(e){v("Error fetching questions"),i.oR.error("Error fetching questions")}finally{y(!1)}})()},[t]),(0,r.useEffect)(()=>()=>{S.current&&clearTimeout(S.current)},[]);let D=e=>{x&&(C.current={answers:e.answers,selfComment:e.selfComment},S.current&&clearTimeout(S.current),S.current=setTimeout(async()=>{try{N("saving");let e={term:t};if(C.current.answers&&(e.answers=C.current.answers),"string"==typeof C.current.selfComment&&(e.selfComment=C.current.selfComment),e.answers||"string"==typeof e.selfComment){if(!(await fetch("/api/teacher-answers",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw Error("Autosave failed");N("saved"),setTimeout(()=>N("idle"),1e3)}else N("idle")}catch(e){N("error")}},600))},T=(e,t)=>{x&&(u(a=>({...a,[e]:t})),D({answers:[{questionId:e,answer:t}],selfComment:void 0}))},q=(e,t,a)=>{var s;let r;if(!x)return;let i=o.find(t=>t.id===e);if(null==i||null==(s=i.options)?void 0:s.some(e=>/target/i.test(e)||/actions to be implemented/i.test(e))){let s={selected:[],details:{}};try{s=c[e]?JSON.parse(c[e]):s,Array.isArray(s.selected)||(s.selected=[]),("object"!=typeof s.details||null===s.details)&&(s.details={})}catch(t){s={selected:c[e]?c[e].split(",").map(e=>e.trim()).filter(Boolean):[],details:{}}}let r=JSON.stringify({selected:a?Array.from(new Set([...s.selected||[],t])):(s.selected||[]).filter(e=>e!==t),details:s.details||{}});u(t=>({...t,[e]:r})),D({answers:[{questionId:e,answer:r}],selfComment:void 0});return}let n=c[e]?c[e].split(",").map(e=>e.trim()).filter(e=>e):[];r=a?[...n,t]:n.filter(e=>e!==t),u(t=>({...t,[e]:r.join(", ")})),D({answers:[{questionId:e,answer:r.join(", ")}],selfComment:void 0})};return b?(0,s.jsx)("div",{className:"flex items-center justify-center min-h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):w&&0===o.length?(0,s.jsx)("div",{className:"text-sm text-gray-600",children:"Failed to load the evaluation form."}):(0,s.jsx)("div",{className:"max-w-3xl mx-auto",children:(0,s.jsxs)("div",{className:"bg-white shadow-md rounded-xl border border-gray-100 overflow-hidden",children:[(0,s.jsxs)("div",{className:"px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-indigo-50 to-blue-50",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:(()=>{switch(t){case"START":return"Start of Year Evaluation";case"END":return"End of Year Evaluation";default:return"Evaluation"}})()}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:(()=>{switch(t){case"START":return"Set your goals and expectations for the academic year";case"END":return"Reflect on your progress and achievements this year";default:return"Complete your evaluation"}})()})]}),(0,s.jsx)("span",{className:"inline-flex px-2.5 py-1 text-xs font-semibold rounded-full ".concat(f?"bg-green-100 text-green-800":"bg-amber-100 text-amber-800"),children:f?"Submitted":"Draft"})]}),(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-600 mb-1",children:[(0,s.jsx)("span",{children:"Progress"}),(0,s.jsxs)("span",{children:[k," of ",E," completed"]})]}),(0,s.jsx)("div",{className:"h-2 w-full rounded-full bg-gray-200 overflow-hidden",children:(0,s.jsx)("div",{className:"h-2 bg-indigo-600",style:{width:"".concat(A,"%")}})})]})]}),(0,s.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),!x)return;let t=o.filter(e=>!c[e.id]||""===c[e.id].trim());if(t.length>0){v("Please answer all questions. Missing: ".concat(t.length," questions")),i.oR.error("Please answer all questions before submitting");return}if(!m.trim()){v("Self comment is required"),i.oR.error("Self comment is required");return}a(o.map(e=>({questionId:e.id,answer:c[e.id]})),m)},className:"p-6",children:[(0,s.jsxs)("div",{className:"space-y-8",children:[o.map((e,t)=>(0,s.jsx)("div",{className:"pb-6",children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("span",{className:"flex-shrink-0 w-7 h-7 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-xs font-semibold",children:t+1}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-3",children:e.question}),"TEXT"===e.type&&(0,s.jsx)("input",{type:"text",value:c[e.id]||"",onChange:t=>T(e.id,t.target.value),className:"block w-full rounded-lg border border-gray-300 bg-white/90 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2",placeholder:"Enter your answer...",disabled:!x,required:!0}),"TEXTAREA"===e.type&&(0,s.jsx)("textarea",{value:c[e.id]||"",onChange:t=>T(e.id,t.target.value),rows:4,className:"block w-full rounded-lg border border-gray-300 bg-white/90 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2",placeholder:"Enter your detailed answer...",disabled:!x,required:!0}),"MCQ"===e.type&&(0,s.jsx)("div",{className:"space-y-3",children:e.options.map((t,a)=>(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"radio",name:"question_".concat(e.id),value:t,checked:c[e.id]===t,onChange:t=>T(e.id,t.target.value),className:"h-4 w-4 accent-indigo-600 focus:ring-indigo-500 border-gray-300",disabled:!x,required:!0}),(0,s.jsx)("span",{className:"ml-3 text-sm text-gray-800",children:t})]},a))}),"CHECKBOX"===e.type&&(()=>{let t=e.options.some(e=>/target/i.test(e)),a=e.options.some(e=>/actions to be implemented/i.test(e));if(!(t||a)){let t=c[e.id]?c[e.id].split(",").map(e=>e.trim()):[];return(0,s.jsx)("div",{className:"space-y-3",children:e.options.map((a,r)=>(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"checkbox",checked:t.includes(a),onChange:t=>q(e.id,a,t.target.checked),className:"h-4 w-4 accent-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",disabled:!x}),(0,s.jsx)("span",{className:"ml-3 text-sm text-gray-800",children:a})]},r))})}let r={selected:[],details:{}};try{r=c[e.id]?JSON.parse(c[e.id]):r,Array.isArray(r.selected)||(r.selected=[]),("object"!=typeof r.details||null===r.details)&&(r.details={})}catch(t){r={selected:c[e.id]?c[e.id].split(",").map(e=>e.trim()).filter(Boolean):[],details:{}}}return(0,s.jsx)("div",{className:"space-y-4",children:e.options.map((t,a)=>(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"checkbox",checked:(r.selected||[]).includes(t),onChange:a=>q(e.id,t,a.target.checked),className:"h-4 w-4 accent-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",disabled:!x}),(0,s.jsx)("span",{className:"ml-3 text-sm text-gray-800",children:t})]}),(/target/i.test(t)||/actions to be implemented/i.test(t))&&(0,s.jsx)("div",{className:"mt-2 ml-7",children:(0,s.jsx)("textarea",{value:r.details&&r.details[t]||"",onChange:a=>((t,a)=>{if(!x)return;let s=JSON.stringify({selected:Array.from(new Set([...r.selected||[],t])),details:{...r.details||{},[t]:a}});u(t=>({...t,[e.id]:s})),D({answers:[{questionId:e.id,answer:s}],selfComment:void 0})})(t,a.target.value),rows:3,className:"block w-full rounded-lg border border-gray-300 bg-white/90 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2",placeholder:/target/i.test(t)?"Enter your target...":"Describe actions to be implemented...",disabled:!x})})]},a))})})()]})]})},e.id)),(0,s.jsxs)("div",{className:"bg-indigo-50/60 rounded-xl p-6 border border-indigo-100",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Self-Assessment Comment"}),(0,s.jsxs)("p",{className:"text-sm text-gray-600 mb-4",children:["Please provide additional comments about your ",t.toLowerCase()," of year evaluation:"]}),(0,s.jsx)("textarea",{value:m,onChange:e=>{h(e.target.value),D({answers:void 0,selfComment:e.target.value})},rows:6,className:"block w-full rounded-lg border border-indigo-200 bg-white/90 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2",placeholder:"Share your thoughts, challenges, achievements, and goals...",disabled:!x,required:!0}),(0,s.jsxs)("div",{className:"mt-2 text-xs text-gray-500 h-4",children:["saving"===j&&"Saving...","saved"===j&&"Saved","error"===j&&"Auto-save failed"]})]})]}),x&&(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-end gap-3 mt-8 pt-6 border-t border-gray-100",children:[(0,s.jsxs)("div",{className:"flex items-center text-xs text-gray-500 mr-auto sm:mr-0",children:["Last saved: ","saving"===j?"saving...":"a moment ago"]}),(0,s.jsx)("button",{type:"button",onClick:()=>D({answers:Object.entries(c).map(e=>{let[t,a]=e;return{questionId:t,answer:a}}),selfComment:m}),className:"px-4 py-2 text-sm font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors border-0",children:"Save Draft"}),(0,s.jsx)("button",{type:"submit",disabled:l,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:l?"Submitting...":"Submit Evaluation"})]}),f&&(0,s.jsx)("div",{className:"mt-8 pt-6 border-t border-gray-200 text-sm text-green-700",children:"Submitted."})]})]})})}},49699:(e,t,a)=>{a.d(t,{w:()=>n});var s=a(12115),r=a(12108);let i={evaluationStatus:null,startData:null,endData:null,termState:null,isLoading:!1,hasData:!1};function n(){let{data:e,status:t}=(0,r.useSession)(),[a,n]=(0,s.useState)(!1),[l,o]=(0,s.useState)(null),d=(0,s.useCallback)(async()=>{if(!i.isLoading&&(!i.hasData||a)){i.isLoading=!0,n(!0),o(null);try{var t;let a=null==e||null==(t=e.user)?void 0:t.departmentId;if(!a)throw Error("No department ID found");let[s,r]=await Promise.all([fetch("/api/teacher-evaluation/status"),fetch("/api/departments/".concat(a,"/term-state"))]);if(!s.ok||!r.ok)throw Error("Failed to load teacher data");let n=await s.json(),l=await r.json(),o=n.data||n,d=l.data||l;i={evaluationStatus:o,startData:null,endData:null,termState:d,isLoading:!1,hasData:!0}}catch(e){o(e instanceof Error?e.message:"Failed to load data"),i.isLoading=!1,i.evaluationStatus=null,i.termState=null}finally{n(!1)}}},[e]),c=(0,s.useCallback)(async e=>{try{let t=await fetch("/api/teacher-evaluation/questions?term=".concat(e));if(!t.ok)throw Error("Failed to fetch ".concat(e," evaluation data"));let a=await t.json(),s=a.data||a;return"START"===e?i.startData=s:i.endData=s,s}catch(e){throw e}},[]),u=(0,s.useCallback)(()=>{i.hasData=!1,i.evaluationStatus=null,i.startData=null,i.endData=null,i.termState=null},[]),m=(0,s.useCallback)(()=>{u(),d()},[d,u]);return(0,s.useEffect)(()=>{var a;"authenticated"!==t||(null==e||null==(a=e.user)?void 0:a.role)!=="TEACHER"||i.hasData||d()},[t,e,d]),(0,s.useEffect)(()=>{!i.evaluationStatus||i.startData||i.endData||(async()=>{try{var e,t,a,s;(null==(t=i.evaluationStatus)||null==(e=t.start)?void 0:e.status)!=="NOT_AVAILABLE"&&await c("START"),(null==(s=i.evaluationStatus)||null==(a=s.end)?void 0:a.status)!=="NOT_AVAILABLE"&&await c("END")}catch(e){console.warn("Auto-fetch of term data failed:",e)}})()},[i.evaluationStatus,i.startData,i.endData,c]),(0,s.useEffect)(()=>{"unauthenticated"===t&&u()},[t,u]),{evaluationStatus:(e=>{if(!e)return null;let t={...e};return t.start&&(t.start.answersCount=Math.min(t.start.answersCount||0,t.start.questionsCount||0)),t.end&&(t.end.answersCount=Math.min(t.end.answersCount||0,t.end.questionsCount||0)),t})(i.evaluationStatus),startData:i.startData,endData:i.endData,termState:i.termState,loading:a||i.isLoading,error:l,refetch:m,invalidateCache:u,fetchTermData:c,submitAnswers:(0,s.useCallback)(async(e,t,a)=>{try{let s=await fetch("/api/teacher-answers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({answers:e,selfComment:t,term:a})});if(!s.ok)throw Error("Failed to submit answers");let r=await s.json(),n=r.data||r;try{let e=await fetch("/api/teacher-evaluation/status");if(e.ok){let t=await e.json(),a=t.data||t;i.evaluationStatus=a}}catch(e){console.warn("Failed to fetch fresh status after submission:",e)}return n}catch(e){throw e}},[]),getEvaluationReport:(0,s.useCallback)(async e=>{try{let t=await fetch("/api/reviews/teacher/evaluation-report?term=".concat(e));if(!t.ok)throw Error("Failed to get evaluation report");let a=await t.json();return a.data||a}catch(e){throw e}},[]),fetchEvaluation:(0,s.useCallback)(async e=>{try{let t=await fetch("/api/teacher-evaluation/".concat(e));if(!t.ok)throw Error("Failed to fetch evaluation");let a=await t.json();return a.data||a}catch(e){throw e}},[]),updateEvaluation:(0,s.useCallback)(async(e,t)=>{try{let a=await fetch("/api/teacher-evaluation/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw Error("Failed to update evaluation");let s=await a.json(),r=s.data||s;return{success:!0,evaluation:r}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}},[]),fetchQuestions:(0,s.useCallback)(async e=>{try{let t=await fetch("/api/teacher-evaluation/questions?term=".concat(e));if(!t.ok)throw Error("Failed to fetch ".concat(e," questions"));let a=await t.json();return a.data||a}catch(e){throw e}},[]),updateAnswers:(0,s.useCallback)(async e=>{try{let t=await fetch("/api/teacher-answers",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Failed to update answers");let a=await t.json();return a.data||a}catch(e){throw e}},[])}}}}]);